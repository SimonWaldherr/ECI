<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>External Code Interface (ECI): Building the ECI sample apps.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">External Code Interface (ECI)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Building the ECI sample apps. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page provide a tutorial on how to build and run the included ECI sample apps using both CFE 6.5 and 6.6. For conciseness, we will refer to the built CFS directory as cfs_dir and the location of the ECI files as eci_dir in this section.</p>
<h1><a class="anchor" id="requirements"></a>
Requirements</h1>
<p>ECI doesn't have any additional depedencies beyond the requirements of the CFS. For the purposes of this tutorial, we'll be using the CFE targeted for linux and so we assume the following are available on your machine:</p>
<ul>
<li>git</li>
<li>gcc-multilib</li>
<li>a Unix based OS</li>
<li>sudo access (not strictly required for the CFS but sudo-less CFS requires additional configuration which is out of the scope of this tutorial)</li>
</ul>
<h1><a class="anchor" id="cfe-6-5"></a>
Building CFS 6.5 ECI</h1>
<p>The older CFE 6.5 utilizes a make-based build system, and so requires some tweaks to integrate the apps. If you're intending to just demo the ECI, we recommend using the build scripts located in the /ci directory of the ECI repo.</p>
<ol type="1">
<li>Clone the <a href="https://github.com/nasa/cFE">CFE repository</a> from GitHub. If you have a working version of CFE 6.5 available feel free to try it, but errors caused by modifications in personal working versions are outside the scope of this tutorial.</li>
<li>Due to recent updates, CFE 6.5 is no longer the master branch. We recommend using commit SHA f26967b80cf3654575c35164b73004c3fc9d84ff as it's the last commit before the transition (and is the commit the ci scripts are tested with). From git we can reset to this hash via: <div class="fragment"><div class="line">git reset --hard f26967b80cf3654575c35164b73004c3fc9d84ff </div>
</div><!-- fragment --></li>
<li><p class="startli">With the repository set to our 6.5 revision, we need to fetch the git submodules using: </p>
<div class="fragment"><div class="line">git submodule update --init --recursive </div>
</div><!-- fragment --><p class="startli">If you'd like to run the UT Assert tests, you will probably also need to apply a fix to this version of UT Assert. We use the stream editor sed to modify these files while in the cloned CFS directory but if you've modified any of these files, the line numbers will most likely be incorrect. </p>
<pre class="fragment">  sed -i '481s/.*/int32 CFE_ES_PoolCreate(CFE_ES_MemHandle_t *HandlePtr, uint8 *MemPtr, uint32 Size)/' tools/ut_assert/src/ut_cfe_es_stubs.c
  sed -i '489s/.*/return(Ut_CFE_ES_HookTable.CFE_ES_PoolCreate((uint32*)HandlePtr, MemPtr, Size));/' tools/ut_assert/src/ut_cfe_es_stubs.c
  sed -i '494s/.*/int32 CFE_ES_PoolCreateEx(CFE_ES_MemHandle_t *HandlePtr, uint8 *MemPtr, uint32 Size, uint32 NumBlockSizes, uint32 *BlockSizes, uint16 UseMutex)/' tools/ut_assert/src/ut_cfe_es_stubs.c
  sed -i '502s/.*/return(Ut_CFE_ES_HookTable.CFE_ES_PoolCreateEx((uint32*)HandlePtr, MemPtr, Size, NumBlockSizes, BlockSizes, UseMutex));/' tools/ut_assert/src/ut_cfe_es_stubs.c

  sed -i '91s/.*/export CFS_PROM_APPS:=$(CFS_PROM)/' ./build/cpu1/Makefile
  sed -i '871s/.*/#define CFE_ES_NONVOL_STARTUP_FILE "\/cf\/cfe_es_startup.scr"/' ./cfe/fsw/platform_inc/cpu1/cfe_platform_cfg.h
  sed -i 's/\/cf\/apps/\/cf/' build/cpu1/exe/cfe_es_startup.scr</pre><p class="startli">This should give us a working version of CFE 6.5. Now we add our simple app.</p>
</li>
<li>Copy the app files from the ECI repository into our new CFE directory: <pre class="fragment">  mkdir &lt;cfs_dir&gt;/apps/simpleECIApp
  cp -r &lt;eci_dir&gt;/examples/simpleECIApp/* &lt;cfs_dir&gt;/apps/simpleECIApp/

  mkdir -p &lt;cfs_dir&gt;/apps/eci/fsw
  cp -r &lt;eci_dir&gt;/fsw/* &lt;cfs_dir&gt;/apps/eci/fsw</pre></li>
<li>Add our apps build instructions to the CFS Makefile. <pre class="fragment">  sed -i '44a THE_APPS += simpleECIApp' &lt;cfs_dir&gt;/build/cpu1/Makefile
  sed -i '50a THE_TBLS += simpleECIApp' &lt;cfs_dir&gt;/build/cpu1/Makefile</pre></li>
<li>Modify the startup script to include our app and the scheduler to send the tick message at 4 Hz. <pre class="fragment">  sed -i '5a CFE_APP, /cf/simpleECIApp.so,          sa_AppMain,     SA_APP,       90,   8192, 0x0, 0;' &lt;cfs_dir&gt;/build/cpu1/exe/cfe_es_startup.scr
  sed -i '26a #include "simpleECI_app_msgids.h"' &lt;cfs_dir&gt;/apps/sch_lab/fsw/platform_inc/sch_lab_sched_tab.h
  sed -i '74a      { SIMPLE_ECI_TICK_MID,   4, 0 },' &lt;cfs_dir&gt;/apps/sch_lab/fsw/platform_inc/sch_lab_sched_tab.h</pre></li>
<li>Now that all the pieces are in place, we can change directory into our CFS directory and run the setvars script to set our build path. Afterwards, we can run make to build our binary. <pre class="fragment">  cd &lt;cfs_dir&gt;
  . ./setvars.sh

  make config
  make</pre></li>
<li><p class="startli">Navigate to the build directory and execute the CFS. </p>
<pre class="fragment">  cd &lt;cfs_dir&gt;/build/cpu1/exe/
  sudo ./core-linux.bin</pre><p class="startli">You should see a message indicating that the CFS has loaded our simple app.</p>
</li>
</ol>
<h1><a class="anchor" id="cfe-6-6"></a>
Building CFS 6.6 ECI</h1>
<p>Building the CFE 6.6 has an additional dependency on cmake3, which must be availabe on your system. We use cmake to build/install our unit tests for 6.6 but this tutorial was meant to illustrate how to build to an arbitrary directory. If you're just interesting in building a fresh CFS with the simple eci app, look to the next section.</p>
<ol type="1">
<li>Clone the premade CFS repository. <div class="fragment"><div class="line">git clone --recursive https:<span class="comment">//github.com/nasa/cFS.git </span></div>
</div><!-- fragment --></li>
<li>Copy the build configuration into the root of the CFS repository. <pre class="fragment">  cp -r &lt;eci_dir&gt;/ci/simple_app/simpleECIApp_defs &lt;cfs_dir&gt;/
  cp &lt;eci_dir&gt;/ci/common_defs &lt;cfs_dir&gt;/simpleECIApp_defs</pre></li>
<li>Copy our modified to_lab and sch_lab files into their respective locations. <pre class="fragment">  cp &lt;eci_dir&gt;/ci/simple_app/to_lab/to_lab_sub_table.h &lt;cfs_dir&gt;/apps/to_lab/fsw/platform_inc
  cp &lt;eci_dir&gt;/ci/simple_app/sch_lab/CMakeLists.txt &lt;cfs_dir&gt;/apps/sch_lab/
  cp &lt;eci_dir&gt;/ci/simple_app/sch_lab/sch_lab_sched_tab.h &lt;cfs_dir&gt;/apps/sch_lab/fsw/platform_inc
  mv &lt;cfs_dir&gt;/cfe/cmake/Makefile.sample &lt;cfs_dir&gt;/Makefile</pre></li>
<li>Add our ECI source to the CFS. <pre class="fragment">  mkdir -p &lt;cfs_dir&gt;/apps/eci/fsw
  cp &lt;eci_dir&gt;/fsw/* &lt;cfs_dir&gt;/apps/eci/fsw/</pre></li>
<li>Add our simple app source code. <pre class="fragment">  cp -r &lt;eci_dir&gt;/examples/simpleECIApp/ &lt;cfs_dir&gt;/apps/</pre></li>
<li>Compile our CFS binaries <pre class="fragment">  cd &lt;cfs_dir&gt;
  make install</pre></li>
<li><p class="startli">Run our built CFS </p>
<pre class="fragment">  cd &lt;cfs_dir&gt;/build/exe/cpu1/
  sudo ./core-cpu1</pre><p class="startli">You should see a message indicating the CFS has started the simple app.</p>
</li>
</ol>
<h1><a class="anchor" id="simple-cfe-6-6"></a>
Building the CFS examples using the ECI 6.6 CMake</h1>
<p>Even though the instructions for building and running our examples with cmake is much easier, we prefer to automate these steps for fast development/testing. We've included a CMakeLists file in each of the apps ci directories for convenience. To build a functioning CFS ecosystem using these directives...</p>
<ol type="1">
<li>Make a temporary directory to use for the cmake out of source build. This is a common practice for cmake so we can leverage it's functionality for organization. <pre class="fragment">mkdir &lt;any_dir&gt;/build </pre></li>
<li>Run cmake targeting the example app you wish to build. We'll use the simple ECI app for consistancy with the above examples. <pre class="fragment">cmake &lt;eci_dir&gt;/ci/simple_app </pre></li>
<li>Change directory into our new cfs directory and run their make file. <pre class="fragment"> cd ./cfs
 make install</pre></li>
<li>We can now run our CFS binary. (We assume the working directory is the built CFS) <pre class="fragment"> cd ./build/exe/cpu1/
 sudo ./core-cpu1</pre> </li>
</ol>
</div></div><!-- contents -->
